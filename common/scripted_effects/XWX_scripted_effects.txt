d_XWX_become_puppet_of_CHI = {

    CHI = {
        set_autonomy = {
            target = XWX
            autonomous_state = autonomy_puppet
            end_wars = no
            end_civil_wars = no
        }
    }

    if = {
        limit = {
            CHI = { NOT = { has_government = neutrality } }
        }
        set_politics = {
            ruling_party = neutrality
            elections_allowed = no
        }
        add_popularity = {
            ideology = neutrality
            popularity = 0.4
        }
    }

    add_opinion_modifier = {
        target = CHI
        modifier = XWX_is_kmt_ally_modifier
    }
    reverse_add_opinion_modifier = {
        target = CHI
        modifier = XWX_is_kmt_ally_modifier
    }
}

d_XWX_gain_cores_on_china = {
    custom_effect_tooltip = XWX_gain_cores_on_china_tt
    hidden_effect = {
        every_state = {
			limit = {
				DEN_is_chinese_state = yes
                NOT = { is_core_of = ROOT }
			}
			add_core_of = ROOT
		}
    }
    log = "ROOT: [ROOT.GetName] gained cores on all chinese states"
}

XWX_improve_provincial_army = {
    if = {
        limit = {
            has_idea = XWX_untrained_provincial_army
        }
        swap_ideas = {
            remove_idea = XWX_untrained_provincial_army
            add_idea = XWX_trained_provincial_army
        }
    }
    if = {
        limit = {
            has_idea = XWX_incompetent_provincial_army
        }
        swap_ideas = {
            remove_idea = XWX_incompetent_provincial_army
            add_idea = XWX_untrained_provincial_army
        }
    }
}

XWX_disband_peoples_militia = {
    if = {
        limit = {
            NOT = { has_country_flag = peoples_militia_disbanded }
            has_template = "People's Militia"
        }
        army_experience = 25
        delete_unit_template_and_units = {
            division_template = "People's Militia"
            disband = yes
        }
        set_country_flag = peoples_militia_disbanded
        custom_effect_tooltip = generic_skip_one_line_tt
    }
}

XWX_remove_kmt_insurgency = {
    if = {
        limit = {
            has_idea = XWX_weak_kmt_insurgency
        }
        remove_ideas = XWX_weak_kmt_insurgency
    }
    if = {
        limit = {
            has_idea = XWX_kmt_insurgency
        }
        remove_ideas = XWX_kmt_insurgency
    }
    if = {
        limit = {
            has_idea = XWX_strong_kmt_insurgency
        }
        remove_ideas = XWX_strong_kmt_insurgency
    }
}

XWX_increase_kmt_power = {
    if = {
        limit = {
            XWX_kmt_active = yes
        }
        custom_effect_tooltip = generic_skip_one_line_tt
        add_to_variable = {
            XWX_kmt_power = 1
            tooltip = XWX_kmt_power_tt
        }
        if = {
            limit = {
                check_variable = {
                    XWX_kmt_power > 4
                }
                has_idea = XWX_weak_kmt_insurgency
            }
            swap_ideas = {
                remove_idea = XWX_weak_kmt_insurgency
                add_idea = XWX_kmt_insurgency
            }
        }
        if = {
            limit = {
                check_variable = {
                    XWX_kmt_power > 17
                }
                has_idea = XWX_kmt_insurgency
            }
            swap_ideas = {
                remove_idea = XWX_kmt_insurgency
                add_idea = XWX_strong_kmt_insurgency
            }
        }
    }
}
XWX_decrease_kmt_power = {
    if = {
        limit = {
            XWX_kmt_active = yes
        }
        custom_effect_tooltip = generic_skip_one_line_tt
        add_to_variable = {
            XWX_kmt_power = -1
            tooltip = XWX_kmt_power_tt
        }
        if = {
            limit = {
                check_variable = {
                    XWX_kmt_power < 1
                }
                has_idea = XWX_weak_kmt_insurgency
            }
            remove_ideas = XWX_weak_kmt_insurgency
        }
        if = {
            limit = {
                check_variable = {
                    XWX_kmt_power < 5
                }
                has_idea = XWX_kmt_insurgency
            }
            swap_ideas = {
                remove_idea = XWX_kmt_insurgency
                add_idea = XWX_weak_kmt_insurgency
            }
        }
        if = {
            limit = {
                check_variable = {
                    XWX_kmt_power < 18
                }
                has_idea = XWX_strong_kmt_insurgency
            }
            swap_ideas = {
                remove_idea = XWX_strong_kmt_insurgency
                add_idea = XWX_kmt_insurgency
            }
        }
    }
}
